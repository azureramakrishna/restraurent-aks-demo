name: Deploy to AKS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  ACR_NAME: saanvikit
  AKS_NAME: saanvikit-aks
  AKS_RESOURCE_GROUP: "saanvikit-aks_group"
  IMAGE_NAME: restaurant-app

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set image tag
      id: meta
      run: echo "tags=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Login to ACR
      run: az acr login --name ${{ env.ACR_NAME }}
    
    - name: Build and push Docker image
      run: |
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tags }} .
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tags }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Install kubelogin
      run: az aks install-cli  
    
    - name: Set AKS context
      run: |
        az aks get-credentials --resource-group ${{ env.AKS_RESOURCE_GROUP }} --name ${{ env.AKS_NAME }}
        kubelogin convert-kubeconfig -l azurecli
    
    - name: Update manifest with image tag
      run: |
        sed -i 's|IMAGE_TAG|${{ needs.build.outputs.image-tag }}|g' k8s/deployment.yaml
    
    - name: Deploy to AKS
      run: kubectl apply -f k8s/deployment.yaml


